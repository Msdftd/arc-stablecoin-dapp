<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ArcVault Deployer</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.4/ethers.umd.min.js"></script>
  <style>
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#0b0e11;--surface:#131820;--s2:#1a2230;--border:#1e293b;--text:#e2e8f0;--dim:#64748b;--accent:#22d3ee;--green:#34d399;--red:#f87171;--orange:#fbbf24}
    body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    body::before{content:'';position:fixed;top:-40%;left:-20%;width:80%;height:80%;background:radial-gradient(ellipse,rgba(34,211,238,.06) 0%,transparent 70%);pointer-events:none}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px;max-width:540px;width:100%;position:relative;z-index:1}
    h1{font-family:'JetBrains Mono',monospace;font-size:22px;background:linear-gradient(135deg,var(--accent),#818cf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px}
    .sub{color:var(--dim);font-size:13px;margin-bottom:24px;font-family:'JetBrains Mono',monospace}
    #log{margin-bottom:16px}
    .m{padding:12px 14px;border-radius:10px;margin-bottom:8px;font-family:'JetBrains Mono',monospace;font-size:12px;word-break:break-all;line-height:1.7}
    .m.i{background:rgba(34,211,238,.06);border:1px solid rgba(34,211,238,.12);color:var(--accent)}
    .m.o{background:rgba(52,211,153,.06);border:1px solid rgba(52,211,153,.12);color:var(--green)}
    .m.e{background:rgba(248,113,113,.06);border:1px solid rgba(248,113,113,.12);color:var(--red)}
    .m.w{background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.12);color:var(--orange)}
    .btn{width:100%;padding:16px;border:none;border-radius:12px;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;background:linear-gradient(135deg,#06b6d4,var(--accent));color:#0b0e11}
    .btn:hover:not(:disabled){box-shadow:0 0 24px rgba(34,211,238,.2);transform:translateY(-1px)}
    .btn:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
    .result{margin-top:20px;padding:20px;background:var(--s2);border-radius:12px;border:1px solid rgba(52,211,153,.15);display:none}
    .result.show{display:block}
    .label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--dim);margin-bottom:8px;font-weight:600}
    .addr{font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--green);word-break:break-all;background:rgba(52,211,153,.05);padding:12px 14px;border-radius:8px;border:1px solid rgba(52,211,153,.12);user-select:all}
    .cbtn{margin-top:12px;padding:12px;width:100%;border-radius:8px;background:rgba(52,211,153,.1);color:var(--green);border:1px solid rgba(52,211,153,.2);font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;transition:all .15s}
    .cbtn:hover{background:rgba(52,211,153,.18)}
    .ns{margin-top:14px;padding:12px;background:rgba(34,211,238,.05);border-radius:8px;font-size:13px;color:var(--dim);line-height:1.6}
    .ns a{color:var(--accent);font-weight:600} .ns strong{color:var(--text)}
    .pb{height:3px;background:var(--s2);border-radius:2px;overflow:hidden;margin-bottom:16px;display:none}
    .pf{height:100%;background:linear-gradient(90deg,var(--accent),#818cf8);border-radius:2px;transition:width .5s ease;width:0%}
    .sp{display:inline-block;animation:sp .8s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
    a{color:var(--accent)}
  </style>
</head>
<body>
<div class="card">
  <h1>ArcVault Deployer</h1>
  <div class="sub">one-click deploy Â· Arc Testnet</div>
  <div class="pb" id="pb"><div class="pf" id="pf"></div></div>
  <div id="log"></div>
  <button class="btn" id="btn" onclick="go()">Deploy ArcVault Contract</button>
  <div class="result" id="result">
    <div class="label">âœ… Your Vault Contract Address</div>
    <div class="addr" id="ca"></div>
    <button class="cbtn" id="cb" onclick="cp()">ðŸ“‹ Copy Address</button>
    <div class="ns">
      Now go to your <a href="https://arc-stablecoin-dapp.vercel.app" target="_blank">ArcVault dApp</a>,
      click <strong>"Deploy & Connect Vault"</strong>, paste this address, and hit <strong>Save</strong>.
    </div>
  </div>
</div>
<script>
const USDC = "0x3600000000000000000000000000000000000000";
const ARC_ID = 5042002;
const ARC_HEX = "0x4CE352";

const SRC = `// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;
interface IERC20 {
    function totalSupply() external view returns (uint256);
    function balanceOf(address account) external view returns (uint256);
    function transfer(address to, uint256 value) external returns (bool);
    function allowance(address owner, address spender) external view returns (uint256);
    function approve(address spender, uint256 value) external returns (bool);
    function transferFrom(address from, address to, uint256 value) external returns (bool);
}
library Address {
    error AddressInsufficientBalance(address account);
    error FailedInnerCall();
    function sendValue(address payable recipient, uint256 amount) internal {
        if (address(this).balance < amount) revert AddressInsufficientBalance(address(this));
        (bool success, ) = recipient.call{value: amount}("");
        if (!success) revert FailedInnerCall();
    }
    function functionCall(address target, bytes memory data) internal returns (bytes memory) {
        return functionCallWithValue(target, data, 0);
    }
    function functionCallWithValue(address target, bytes memory data, uint256 value) internal returns (bytes memory) {
        if (address(this).balance < value) revert AddressInsufficientBalance(address(this));
        (bool success, bytes memory returndata) = target.call{value: value}(data);
        return _v(target, success, returndata);
    }
    function _v(address target, bool success, bytes memory data) internal view returns (bytes memory) {
        if (!success) { if (data.length > 0) { assembly { revert(add(32, data), mload(data)) } } else { revert FailedInnerCall(); } }
        else { if (data.length == 0 && target.code.length == 0) revert FailedInnerCall(); return data; }
    }
}
library SafeERC20 {
    using Address for address;
    error SafeERC20FailedOperation(address token);
    function safeTransfer(IERC20 token, address to, uint256 value) internal { _c(token, abi.encodeCall(token.transfer, (to, value))); }
    function safeTransferFrom(IERC20 token, address from, address to, uint256 value) internal { _c(token, abi.encodeCall(token.transferFrom, (from, to, value))); }
    function _c(IERC20 token, bytes memory data) private { bytes memory r = address(token).functionCall(data); if (r.length != 0 && !abi.decode(r, (bool))) revert SafeERC20FailedOperation(address(token)); }
}
abstract contract ReentrancyGuard {
    uint256 private constant _N = 1; uint256 private constant _E = 2; uint256 private _s;
    error ReentrancyGuardReentrantCall();
    constructor() { _s = _N; }
    modifier nonReentrant() { if (_s == _E) revert ReentrancyGuardReentrantCall(); _s = _E; _; _s = _N; }
}
contract ArcVault is ReentrancyGuard {
    using SafeERC20 for IERC20;
    IERC20 public immutable usdc;
    mapping(address => uint256) public balances;
    event Deposited(address indexed user, uint256 amount, uint256 timestamp);
    event Withdrawn(address indexed user, uint256 amount, uint256 timestamp);
    event Transferred(address indexed from, address indexed to, uint256 amount, uint256 timestamp);
    error ZeroAmount(); error ZeroAddress(); error InsufficientBalance(uint256 requested, uint256 available);
    constructor(address _usdc) { if (_usdc == address(0)) revert ZeroAddress(); usdc = IERC20(_usdc); }
    function deposit(uint256 amount) external nonReentrant { if (amount == 0) revert ZeroAmount(); balances[msg.sender] += amount; usdc.safeTransferFrom(msg.sender, address(this), amount); emit Deposited(msg.sender, amount, block.timestamp); }
    function withdraw(uint256 amount) external nonReentrant { if (amount == 0) revert ZeroAmount(); if (balances[msg.sender] < amount) revert InsufficientBalance(amount, balances[msg.sender]); balances[msg.sender] -= amount; usdc.safeTransfer(msg.sender, amount); emit Withdrawn(msg.sender, amount, block.timestamp); }
    function transfer(address to, uint256 amount) external nonReentrant { if (to == address(0)) revert ZeroAddress(); if (amount == 0) revert ZeroAmount(); if (balances[msg.sender] < amount) revert InsufficientBalance(amount, balances[msg.sender]); balances[msg.sender] -= amount; balances[to] += amount; usdc.safeTransfer(to, amount); emit Transferred(msg.sender, to, amount, block.timestamp); }
    function balanceOf(address account) external view returns (uint256) { return balances[account]; }
    function totalVaultBalance() external view returns (uint256) { return usdc.balanceOf(address(this)); }
}`;

let deployed = "";

function log(h, t="i") {
  const d = document.createElement("div");
  d.className = "m " + t;
  d.innerHTML = h;
  document.getElementById("log").appendChild(d);
}
function clr() { document.getElementById("log").innerHTML = ""; }
function prog(p) {
  document.getElementById("pb").style.display = "block";
  document.getElementById("pf").style.width = p + "%";
}

// â”€â”€ Compile via Web Worker (importScripts is the official way to load solc in browser) â”€â”€
function compileSolidity(source) {
  return new Promise((resolve, reject) => {
    // Build worker code as a string â€” worker loads solc via importScripts
    const code = `
self.onmessage = function(e) {
  try {
    importScripts("https://binaries.soliditylang.org/bin/soljson-v0.8.20+commit.a1b79de6.js");
    var solc = Module;
    var compile = solc.cwrap("solidity_compile", "string", ["string", "number", "number"]);
    var input = JSON.stringify({
      language: "Solidity",
      sources: { "ArcVault.sol": { content: e.data } },
      settings: {
        optimizer: { enabled: true, runs: 200 },
        outputSelection: { "*": { "*": ["abi", "evm.bytecode.object"] } }
      }
    });
    var result = compile(input, 0, 0);
    self.postMessage({ ok: true, data: result });
  } catch(err) {
    self.postMessage({ ok: false, error: err.message || String(err) });
  }
};`;

    const blob = new Blob([code], { type: "text/javascript" });
    const url = URL.createObjectURL(blob);
    const w = new Worker(url);

    const timer = setTimeout(() => {
      w.terminate();
      URL.revokeObjectURL(url);
      reject(new Error("Compilation timed out after 90s. Refresh and retry."));
    }, 90000);

    w.onmessage = function(e) {
      clearTimeout(timer);
      w.terminate();
      URL.revokeObjectURL(url);
      if (e.data.ok) resolve(e.data.data);
      else reject(new Error(e.data.error));
    };

    w.onerror = function(e) {
      clearTimeout(timer);
      w.terminate();
      URL.revokeObjectURL(url);
      reject(new Error("Worker error: " + (e.message || "unknown")));
    };

    w.postMessage(source);
  });
}

async function go() {
  const btn = document.getElementById("btn");
  btn.disabled = true;
  btn.innerHTML = '<span class="sp">âŸ³</span> Working...';
  clr();

  try {
    // 1 â€” MetaMask
    if (!window.ethereum) throw new Error("MetaMask not found! Install MetaMask first.");
    prog(5);
    log("Connecting wallet...");

    const provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    let signer = await provider.getSigner();
    const addr = await signer.getAddress();
    const { chainId } = await provider.getNetwork();
    log("Wallet: <strong>" + addr.slice(0,6) + "..." + addr.slice(-4) + "</strong>", "o");

    // 2 â€” Network
    prog(10);
    if (Number(chainId) !== ARC_ID) {
      log("Switching to Arc Testnet...", "w");
      try {
        await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: ARC_HEX }] });
      } catch (err) {
        if (err.code === 4902 || err.code === -32603) {
          await window.ethereum.request({ method: "wallet_addEthereumChain", params: [{
            chainId: ARC_HEX, chainName: "Arc Network Testnet",
            rpcUrls: ["https://rpc.testnet.arc.network"],
            nativeCurrency: { name: "USDC", symbol: "USDC", decimals: 18 },
            blockExplorerUrls: ["https://testnet.arcscan.app"],
          }] });
        } else throw new Error("Switch to Arc Testnet in MetaMask manually.");
      }
      const p2 = new ethers.BrowserProvider(window.ethereum);
      signer = await p2.getSigner();
      log("Arc Testnet âœ“", "o");
    } else {
      log("Arc Testnet (chain " + ARC_ID + ") âœ“", "o");
    }

    // 3 â€” Compile
    prog(15);
    log("Loading Solidity compiler (~6MB)...<br>This takes 15-30 seconds, please wait...");

    const raw = await compileSolidity(SRC);
    const output = JSON.parse(raw);

    if (output.errors) {
      const fatal = output.errors.filter(function(e) { return e.severity === "error"; });
      if (fatal.length) throw new Error("Compile: " + fatal[0].formattedMessage);
    }

    const c = output.contracts["ArcVault.sol"]["ArcVault"];
    if (!c) throw new Error("ArcVault not found in output");

    const abi = c.abi;
    const bytecode = "0x" + c.evm.bytecode.object;
    prog(60);
    log("Compiled âœ“ (" + Math.round(bytecode.length / 2) + " bytes)", "o");

    // 4 â€” Deploy
    log("Deploying to Arc Testnet...<br>ðŸ‘‰ <strong>Confirm the transaction in MetaMask</strong>");

    const factory = new ethers.ContractFactory(abi, bytecode, signer);
    const contract = await factory.deploy(USDC);

    const txHash = contract.deploymentTransaction().hash;
    prog(80);
    log('Tx: <a href="https://testnet.arcscan.app/tx/' + txHash + '" target="_blank">' + txHash.slice(0,22) + "..." + txHash.slice(-6) + "</a>");
    log("Waiting for block confirmation...");

    await contract.waitForDeployment();
    deployed = await contract.getAddress();

    prog(100);
    log("ðŸŽ‰ <strong>ArcVault deployed!</strong><br>" + deployed, "o");

    document.getElementById("ca").textContent = deployed;
    document.getElementById("result").classList.add("show");
    btn.innerHTML = "âœ… Deployed!";

  } catch (e) {
    const msg = e?.info?.error?.message || e?.reason || e?.message || "Unknown error";
    log(msg, "e");
    btn.disabled = false;
    btn.innerHTML = "Retry Deploy";
    document.getElementById("pb").style.display = "none";
  }
}

function cp() {
  navigator.clipboard.writeText(deployed).then(() => {
    const b = document.getElementById("cb");
    b.textContent = "âœ“ Copied!";
    setTimeout(() => b.textContent = "ðŸ“‹ Copy Address", 2000);
  });
}
</script>
</body>
</html>
